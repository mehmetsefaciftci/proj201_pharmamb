generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  PHARMACIST
  STAFF
}

enum SaleStatus {
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentType {
  CASH
  CARD
  OTHER
}

enum CashStatus {
  OPEN
  CLOSED
}

enum InvoiceStatus {
  SENT
  ERROR
}

enum ProductType {
  GENERAL
  ANTIBIOTIC
}

enum PrescriptionStatus {
  VERIFIED
  PENDING
}

enum EfaturaStatus {
  DRAFT
  SENT
  ERROR
}

model Pharmacy {
  id             Int            @id @default(autoincrement())
  name           String
  city           String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  users          User[]
  products       Product[]
  sales          Sale[]
  invoices       Invoice[]
  efaturas       Efatura[]
  cashRegisters  CashRegister[]
  prescriptions  Prescription[]
  heldSales      HeldSale[]

  @@index([city])
  @@unique([name, city])
}

model User {
  id           Int       @id @default(autoincrement())
  name         String
  email        String    @unique
  passwordHash String
  role         Role      @default(STAFF)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  pharmacyId   Int
  pharmacy     Pharmacy  @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  sales        Sale[]
  openedCash   CashRegister[] @relation("CashRegisterOpenedBy")
  prescriptions Prescription[]
  heldSales     HeldSale[]

  @@index([pharmacyId])
  @@index([role])
}

model Product {
  id                Int       @id @default(autoincrement())
  barcode           String
  qrCode            String?
  name              String
  price             Decimal   @db.Decimal(10, 2)
  stock             Int       @default(0)
  lowStockThreshold Int       @default(5)
  productType       ProductType @default(GENERAL)
  expiryDate        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  pharmacyId        Int
  pharmacy          Pharmacy  @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  saleItems         SaleItem[]
  heldSaleItems     HeldSaleItem[]

  @@unique([pharmacyId, barcode])
  @@unique([pharmacyId, qrCode])
  @@index([pharmacyId])
  @@index([name])
  @@index([expiryDate])
}

model Sale {
  id          Int         @id @default(autoincrement())
  total       Decimal     @db.Decimal(10, 2)
  paymentType PaymentType @default(CASH)
  status      SaleStatus  @default(COMPLETED)
  createdAt   DateTime    @default(now())

  pharmacyId  Int
  pharmacy    Pharmacy    @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  userId      Int
  user        User        @relation(fields: [userId], references: [id], onDelete: Restrict)

  prescriptionId Int?
  prescription   Prescription? @relation(fields: [prescriptionId], references: [id], onDelete: SetNull)

  items       SaleItem[]
  invoice     Invoice?
  efatura     Efatura?

  @@index([pharmacyId, createdAt])
  @@index([status])
}

model HeldSale {
  id             Int       @id @default(autoincrement())
  note           String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  pharmacyId     Int
  pharmacy       Pharmacy  @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  createdById    Int
  createdBy      User      @relation(fields: [createdById], references: [id], onDelete: Restrict)

  prescriptionId Int?
  prescription   Prescription? @relation(fields: [prescriptionId], references: [id], onDelete: SetNull)

  items          HeldSaleItem[]

  @@index([pharmacyId, createdAt])
}

model HeldSaleItem {
  id         Int      @id @default(autoincrement())
  quantity   Int
  unitPrice  Decimal  @db.Decimal(10, 2)
  lineTotal  Decimal  @db.Decimal(10, 2)

  heldSaleId Int
  heldSale   HeldSale @relation(fields: [heldSaleId], references: [id], onDelete: Cascade)

  productId  Int
  product    Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([heldSaleId])
  @@index([productId])
}

model Prescription {
  id              Int                @id @default(autoincrement())
  patientTc       String
  prescriptionNo  String
  status          PrescriptionStatus @default(VERIFIED)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  pharmacyId      Int
  pharmacy        Pharmacy           @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  createdById     Int
  createdBy       User               @relation(fields: [createdById], references: [id], onDelete: Restrict)

  sales           Sale[]
  heldSales       HeldSale[]

  @@unique([pharmacyId, patientTc, prescriptionNo])
  @@index([pharmacyId])
  @@index([prescriptionNo])
  @@index([patientTc])
}

model SaleItem {
  id        Int      @id @default(autoincrement())
  quantity  Int
  unitPrice Decimal  @db.Decimal(10, 2)
  lineTotal Decimal  @db.Decimal(10, 2)

  saleId    Int
  sale      Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([saleId])
  @@index([productId])
}

model CashRegister {
  id           Int        @id @default(autoincrement())
  status       CashStatus @default(OPEN)
  openingCash  Decimal    @db.Decimal(10, 2)
  closingCash  Decimal?   @db.Decimal(10, 2)
  openedAt     DateTime   @default(now())
  closedAt     DateTime?

  pharmacyId   Int
  pharmacy     Pharmacy   @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  openedById   Int
  openedBy     User       @relation("CashRegisterOpenedBy", fields: [openedById], references: [id], onDelete: Restrict)

  @@index([pharmacyId, status])
}

model Invoice {
  id         Int           @id @default(autoincrement())
  invoiceNo  String
  status     InvoiceStatus @default(SENT)
  pdfUrl     String?
  createdAt  DateTime      @default(now())

  pharmacyId Int
  pharmacy   Pharmacy      @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  saleId     Int
  sale       Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@unique([saleId])
  @@index([pharmacyId, createdAt])
}

model Efatura {
  id         Int           @id @default(autoincrement())
  invoiceNo  String
  status     EfaturaStatus @default(DRAFT)
  pdfUrl     String?
  createdAt  DateTime      @default(now())

  pharmacyId Int
  pharmacy   Pharmacy      @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  saleId     Int
  sale       Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@unique([saleId])
  @@index([pharmacyId, createdAt])
}
